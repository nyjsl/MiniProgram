import * as tslib_1 from "tslib";
import { Basement as Base, WHITELIST_EXTENSIONS, assert, OSSUploadHeaderList, BasementClientError, ErrorType, ErrorName, ErrorCode, OSSUploadResponseFormat, } from '@ant-basement/core';
import { DbService, FileService, AuthService, FunctionService, AppService, } from '@ant-basement/services';
import { MiniProgramHTTPTransport } from './transport';
import mime from 'mime/lite';
var MiniProgramFileService = (function (_super) {
    tslib_1.__extends(MiniProgramFileService, _super);
    function MiniProgramFileService() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    MiniProgramFileService.prototype.uploadFile = function (options) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var relativePath, extension, meta, headers, uploadRes, uploadOptions;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        assert(options.filePath && typeof options.filePath === 'string', 'missing options.filePath');
                        relativePath = options.filePath.replace(/(.*):\/\//, '');
                        extension = relativePath.split('.').pop();
                        assert(WHITELIST_EXTENSIONS.includes(extension.toLowerCase()), "\u76EE\u524D\u4E0D\u652F\u6301 " + extension + " \u7C7B\u578B\u6587\u4EF6");
                        meta = Object.keys(options.meta || {}).reduce(function (accu, key) {
                            accu["x-oss-meta-" + key] = options.meta[key];
                            return accu;
                        }, {});
                        headers = options.headers ? OSSUploadHeaderList.reduce(function (accu, key) {
                            var fieldName = key.replace(/\-[A-Z]/g, function (match) { return match[1]; }).replace(/^[A-Z]/, function (match) { return match.toLowerCase(); });
                            if (options.headers.hasOwnProperty(fieldName))
                                accu[key] = options.headers[fieldName];
                            return accu;
                        }, {}) : {};
                        return [4, this.getOSSUploadOptionsFromPath(relativePath, options.path, options.fileSize)];
                    case 1:
                        uploadRes = _a.sent();
                        if (uploadRes.error) {
                            throw new BasementClientError(ErrorName.INTERFACE_ERROR, ErrorCode.INTERFACE_RESPONSE_FAILED, ErrorType.COMMON_ERROR, uploadRes.error.message);
                        }
                        uploadOptions = OSSUploadResponseFormat(uploadRes.result);
                        return [4, this.uploadFileToOSS(options, uploadOptions, headers, meta)];
                    case 2:
                        _a.sent();
                        return [4, this.reportOSSUpload(uploadOptions.id, mime.getType(options.extension))];
                    case 3:
                        _a.sent();
                        return [2, {
                                fileUrl: "https://" + uploadOptions.host + "/" + uploadOptions.key,
                                filePath: uploadOptions.key,
                            }];
                }
            });
        });
    };
    MiniProgramFileService.prototype.uploadFileToOSS = function (fileUploadOptions, ossUploadOptions, headers, meta) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, uploadHeader, contentType;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        options = ['key', 'policy', 'Signature', 'OSSAccessKeyId'].reduce(function (accu, key) {
                            accu[key] = ossUploadOptions[key];
                            return accu;
                        }, ossUploadOptions);
                        uploadHeader = {};
                        if (fileUploadOptions.extension) {
                            contentType = mime.getType(fileUploadOptions.extension);
                            if (!contentType) {
                                throw new BasementClientError(ErrorName.VALIDATION_ERROR, ErrorCode.VALIDATION_FAILED, ErrorType.COMMON_ERROR, '文件扩展错误，无法解析正确的 MIME');
                            }
                            uploadHeader['Content-Type'] = contentType;
                        }
                        headers['Cache-Control'] = 'max-age=2592000';
                        return [4, this.transport.upload("https://" + ossUploadOptions.host, Object.assign({ success_action_status: 200 }, headers, meta, options), 'file', fileUploadOptions.filePath, uploadHeader)];
                    case 1:
                        _a.sent();
                        return [2];
                }
            });
        });
    };
    return MiniProgramFileService;
}(FileService));
var Basement = (function (_super) {
    tslib_1.__extends(Basement, _super);
    function Basement(appGlobal, options) {
        var _this = _super.call(this, tslib_1.__assign({}, options, { httpClient: appGlobal, httpTransport: MiniProgramHTTPTransport })) || this;
        assert(options.clientSecret, 'client secret is required');
        if (Object.keys(options).length === 0) {
            console.error('云服务配置不存在');
            return _this;
        }
        if (!options.appId) {
            appGlobal.showToast({ content: '请检查是否选择应用' });
            return _this;
        }
        if (!options.spaceId) {
            appGlobal.showToast({ content: '请检查是否选择云服务' });
            return _this;
        }
        _this.db = new DbService(_this.transport);
        _this.user = new AuthService(_this.transport);
        _this.file = new MiniProgramFileService(_this.transport);
        _this.function = new FunctionService(_this.transport);
        _this.appService = new AppService(_this.transport);
        if (appGlobal.remoteLog) {
            appGlobal.remoteLog({
                type: 'behavior',
                seedId: 'basementVersion',
                param1: _this.version,
                bizType: 'basement',
                logLevel: 1,
                actionId: 'event',
            });
        }
        return _this;
    }
    Object.defineProperty(Basement.prototype, "version", {
        get: function () {
            return VERSION;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Basement.prototype, "ua", {
        get: function () {
            return "pkg_name:@ant-basement/miniprogram-sdk;ver:" + this.version + ";";
        },
        enumerable: true,
        configurable: true
    });
    Basement.prototype.createTransport = function (options) {
        _super.prototype.createTransport.call(this, options);
        this.transport.setAppSecret(options.clientSecret).setUA(this.ua);
    };
    return Basement;
}(Base));
export { Basement };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYmFzZW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxRQUFRLElBQUksSUFBSSxFQUNoQixvQkFBb0IsRUFFcEIsTUFBTSxFQUlOLG1CQUFtQixFQUNuQixtQkFBbUIsRUFDbkIsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsdUJBQXVCLEdBQ3hCLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUNMLFNBQVMsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLGVBQWUsRUFBcUIsVUFBVSxHQUNwRixNQUFNLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2RCxPQUFPLElBQUksTUFBTSxXQUFXLENBQUM7QUFFN0I7SUFBcUMsa0RBQVc7SUFBaEQ7O0lBK0VBLENBQUM7SUF6RWMsMkNBQVUsR0FBdkIsVUFBd0IsT0FBMEI7Ozs7Ozt3QkFDaEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLElBQUksT0FBTyxPQUFPLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSwwQkFBMEIsQ0FBQyxDQUFDO3dCQUV2RixZQUFZLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO3dCQUN6RCxTQUFTLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzt3QkFDaEQsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxvQ0FBUyxTQUFTLDhCQUFPLENBQUMsQ0FBQzt3QkFFcEYsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQyxJQUFJ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